<template>
<AuthenticatedLayout>
  <template #header>
      <h2 class="text-xl font-semibold leading-tight text-[#611232]">
        Resultados Finales del Concurso
      </h2>
    </template>

   <div class="flex flex-col lg:flex-row min-h-screen py-6 px-4 lg:px-12 bg-[#F8F9FA]">
      <!-- Menú lateral -->
      <MenuLateral :rol="userRole" @menu-selected="handleMenuSelected" />

      <main 
        class="w-full max-w-4xl mx-auto p-8 bg-white shadow-lg rounded-lg relative"
        :class="{ 'opacity-50 pointer-events-none': mostrarModalEvaluaciones || mostrarModalInscripcion || mostrarModalCerrar }"
      >

        <div class="container mx-auto px-4 py-8">
          <h1 class="text-3xl font-bold mb-8 text-center text-indigo-600">Resultados Finales</h1>

          <div
            v-for="(modalidadData, modalidad) in modalidadesAgrupadas"
            :key="modalidad"
            class="mb-12 space-y-6"
          >
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">{{ modalidad }}</h2>

          <!-- Podio Circular -->
          <div class="flex justify-center items-end space-x-10 mt-12">
            <!-- 2do Lugar -->
            <div class="flex flex-col items-center">
              <div class="w-28 h-28 bg-gradient-to-br from-gray-200 to-gray-400 rounded-full flex flex-col justify-center items-center shadow-lg border-4 border-gray-500">
                <span class="text-3xl">🥈</span>
              </div>
              <p class="mt-2 text-lg font-bold text-gray-700">2do Lugar</p>
              <p class="text-sm text-gray-500">{{ modalidadData.podio[1]?.equipo?.proyecto?.nombre || 'Sin nombre' }}</p>
              <p class="text-xs text-gray-400">Prom: {{ modalidadData.podio[1]?.promedio_final }}</p>
            </div>

            <!-- 1er Lugar -->
            <div class="flex flex-col items-center -mt-12">
              <div class="w-36 h-36 bg-gradient-to-br from-yellow-300 to-yellow-500 rounded-full flex flex-col justify-center items-center shadow-2xl border-4 border-yellow-600">
                <span class="text-4xl">🥇</span>
              </div>
              <p class="mt-2 text-lg font-bold text-yellow-800">1er Lugar</p>
              <p class="text-sm text-yellow-700">{{ modalidadData.podio[0]?.equipo?.proyecto?.nombre || 'Sin nombre' }}</p>
              <p class="text-xs text-yellow-600">Prom: {{ modalidadData.podio[0]?.promedio_final }}</p>
            </div>

            <!-- 3er Lugar -->
            <div class="flex flex-col items-center">
              <div class="w-28 h-28 bg-gradient-to-br from-orange-300 to-orange-500 rounded-full flex flex-col justify-center items-center shadow-lg border-4 border-orange-600">
                <span class="text-3xl">🥉</span>
              </div>
              <p class="mt-2 text-lg font-bold text-orange-800">3er Lugar</p>
              <p class="text-sm text-orange-700">{{ modalidadData.podio[2]?.equipo?.proyecto?.nombre || 'Sin nombre' }}</p>
              <p class="text-xs text-orange-600">Prom: {{ modalidadData.podio[2]?.promedio_final }}</p>
            </div>
          </div>


            <!-- Tabla de Resultados Vertical y 100% Responsive -->
            <div class="w-full overflow-hidden rounded-xl shadow-lg border border-gray-200">
              <table class="w-full min-w-full text-sm text-gray-800 bg-white">
                <thead>
                  <tr class="bg-indigo-100 text-gray-900">
                    <th class="py-3 px-5 text-left font-bold whitespace-nowrap">Posición</th>
                    <th class="py-3 px-5 text-left font-bold whitespace-nowrap">Proyecto</th>
                    <th class="py-3 px-5 text-left font-bold whitespace-nowrap">Promedio Final</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    v-for="(res, idx) in modalidadData.resultados"
                    :key="idx"
                    :class="[
                      'transition duration-200 hover:bg-indigo-50',
                      idx === 0 ? 'bg-yellow-100 font-bold' :
                      idx === 1 ? 'bg-gray-200 font-semibold' :
                      idx === 2 ? 'bg-orange-100 font-medium' : ''
                    ]"
                  >
                  <!-- Muestra los datos para verlos -->
                    <td class="py-3 px-5 border-t text-center">{{ idx + 1 }}</td>
                    <td class="py-3 px-5 border-t truncate max-w-[250px]">{{ res.equipo?.proyecto?.nombre || 'Sin nombre' }}</td>
                    <td class="py-3 px-5 border-t text-center">{{ res.promedio_final }}</td>
                   <td
                      v-if="props.auth?.user?.rol === 'admin'"
                      class="py-3 px-5 border-t text-center"
                    >
                      <button
                        class="px-2 py-1 text-xs rounded"
                        :class="res.clasificado ? 'bg-red-600 hover:bg-red-700 text-white' : 'bg-green-600 hover:bg-green-700 text-white'"
                        @click="toggleClasificacion(res.id, res.equipo?.lider?.id, 'clasificado_estatal', res.clasificado)"
                      >
                        {{ res.clasificado ? 'Degradar' : 'Clasificar' }}
                      </button>
                    </td>




                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="flex justify-end mb-4">
          <a
            :href="route('resultados.pdf')"
            target="_blank"
            class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow inline-flex items-center"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h4a1 1 0 011 1v7h3.586a1 1 0 01.707 1.707l-5.586 5.586a1 1 0 01-1.414 0L1.707 11.707A1 1 0 012.414 10H6V3z" clip-rule="evenodd" />
            </svg>
            Descargar PDF de resultados
          </a>
        </div>

      </main>
    
  </div>
</AuthenticatedLayout>
   
  
</template>


<script setup>
import { ref } from 'vue'
import MenuLateral from '@/ComponentsConcursos/MenuLateral.vue';
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue';
import { usePage } from '@inertiajs/vue3';
import Swal from 'sweetalert2';


const handleMenuSelected = (menu) => {
  selectedMenu.value = menu.toLowerCase();
  showForm.value = selectedMenu.value !== 'concursos';

  if (selectedMenu.value === 'concursos') {
    showForm.value = false;
  } else if (selectedMenu.value === 'gestión de proyectos') {
    router.get(route('gestion.proyectos'));
  } else if (selectedMenu.value === 'registro de criterios') {
    showForm.value = true;
  } else if (selectedMenu.value === 'equipos registrados') {
    router.get(route('equipos.registrados'));
  }
};


const props = defineProps({
  podio: Array,
  resultados: Array,
  clasificaciones: Array,
  agrupados: Object,
  modalidadesAgrupadas: Object,
  auth: Object
});

const userRole = usePage().props.value?.auth?.user?.rol || 'invitado';

const activeTab = ref(
  props.agrupados && typeof props.agrupados === 'object'
    ? Object.keys(props.agrupados)[0]
    : ''
);

const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

async function toggleClasificacion(resultadoId, userId, fase, estadoActual) {
  console.log('Datos a enviar:', { resultadoId, userId, fase, estadoActual });
  if (!resultadoId || !userId) {
    await Swal.fire({
      icon: 'error',
      title: 'Datos incompletos',
      text: 'No se encontró información suficiente para continuar.'
    });
    return;
  }

  try {
    const response = await fetch(route('usuarios.toggleClasificacion'), {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-TOKEN': csrfToken
      },
      body: JSON.stringify({
        resultado_id: resultadoId,
        user_id: userId,
        fase_clasificado: estadoActual ? null : `clasificado_${fase}`, // ej: clasificado_local
        clasificado: estadoActual ? false : true,
      })
    });

    if (!response.ok) throw new Error('Error en la transacción');

    const data = await response.json();

    if (data.success) {
      await Swal.fire({
        icon: 'success',
        title: '¡Éxito!',
        text: `Usuario ${estadoActual ? 'degradado' : 'clasificado'} exitosamente.`
      });
      location.reload();
    } else {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: data.message || 'Ocurrió un error al actualizar la clasificación.'
      });
    }
  } catch (error) {
    Swal.fire({
      icon: 'error',
      title: 'Oops...',
      text: 'Ocurrió un error al ejecutar la transacción.'
    });
    console.error(error);
  }
}

console.log("Agrupación visual (modalidadesAgrupadas):", props.modalidadesAgrupadas);
</script>
